<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width,initial-scale=1,user-scalable=0" name="viewport">
    <title>服务对象满意度成绩展示</title>
    <!-- import CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- 引入 WeUI CDN 链接 -->
    <link href="https://res.wx.qq.com/open/libs/weui/2.3.0/weui.min.css" rel="stylesheet"/>
    <script type="text/javascript" src="https://res.wx.qq.com/open/libs/weuijs/1.2.1/weui.min.js"></script>
    <script src="js/lib/zepto/zepto.js" type="text/javascript"></script>
    <script src="js/lib/zepto/event.js" type="text/javascript"></script>
    <script src="js/lib/zepto/touch.js" type="text/javascript"></script>
    <script src="js/lib/zepto/fx_methods.js" type="text/javascript"></script>
    <script src="js/lib/zepto/fx.js" type="text/javascript"></script>
    <script src="js/lib/zepto/ajax.js" type="text/javascript"></script>
</head>
<style>
    .el-tree .el-tree-node__content{
        height: 50px;
    }
    .custom-tree-node{
        display: flex;
        width: 85%;
        justify-content: space-between;
    }
</style>
<body>
<div id="app">
    <el-tree
            :data="data"
            :props="defaultProps"
            @node-click="handleNodeClick"
            accordion
            highlight-current
            node-key="id"
            lazy
            :load="getOrgList"
    >
        <span class="custom-tree-node" slot-scope="{ node, data }">
            <span>{{ node.label }}</span>
            <span>
              <el-button
                      type="text"
                      size="mini">
                {{data.votes}}
              </el-button>
            </span>
        </span>
    </el-tree>
    <div id="toast" style="display: none;">
        <div class="weui-mask_transparent"></div>
        <div class="weui-toast">
            <i class="weui-icon-success-no-circle weui-icon_toast"></i>
            <p class="weui-toast__content">已完成</p>
        </div>
    </div>
</div>
</body>
<!-- import Vue before Element -->
<script src="js/lib/vue/vue.js"></script>
<!-- import JavaScript -->
<script src="js/lib/element/index.js"></script>
<script>
    new Vue({
        el: '#app',
        data() {
            return {
                data: null,
                defaultProps: {
                    children: 'children',
                    label: 'label',
                    isLeaf: 'isClick'
                }
            };
        },
        created(){
            $.getJSON('./json/city.json', (data)=>{
                this.data = data.data;
                $.ajax({
                    type: 'POST',
                    url: '/gateway/dynamic/restapi/group_result',
                    success: (re) => {
                        let res = re.data;
                        for (let i = 0;i < this.data.length;i ++){
                            this.data[i]['votes'] = res[this.data[i]['id']];
                            for (let j = 0;j < this.data[i].children.length; j ++){
                                this.data[i].children[j]['votes'] = res[this.data[i].children[j]['id']];
                            }
                        }
                    },
                    error:function (err) {
                        $('#toast').find('.weui-toast__content').text('服务异常');
                        $('#toast').fadeIn(100);
                        setTimeout(function () {
                            $('#toast').fadeOut(100);
                        }, 1000);
                    }
                })
            })
        },
        methods: {
            handleNodeClick(data) {
                //判断是否可点击
                let isClick = data.isClick;
                if (isClick != undefined){
                    if (isClick){
                        let response_id = data.id;
                        sessionStorage.setItem('institutionId',response_id);
                        window.location.href = 'appraise.html';
                    }
                }
            },
            getOrgList(node,resolve){
                if (node.level == 2){
                    let id = node.data.id;
                    let isChild = node.data.children;
                    //判断是否由children
                    if (isChild === null){
                        $.getJSON('./json/'+id+'.json', (res)=>{
                            node.data.children = res.data;
                            $.ajax({
                                type: 'POST',
                                url: '/gateway/dynamic/restapi/detail_result',
                                data: id,
                                success:function (re) {
                                    let res = re.data;
                                    for (let i = 0;i < node.data.children.length;i ++){
                                        node.data.children[i]['votes'] = res[node.data.children[i]['id']];
                                    }
                                    resolve(node.data.children);
                                },
                                error:function (err) {
                                    $('#toast').find('.weui-toast__content').text('服务异常');
                                    $('#toast').fadeIn(100);
                                    setTimeout(function () {
                                        $('#toast').fadeOut(100);
                                    }, 1000);
                                }
                            })
                        })
                    }
                    // if (!data.children) {
                    //     this.$set(data, 'children', null);
                    // }
                }else if (node.level == 1){
                    let isChild = node.data.children;
                    resolve(isChild);
                }else {
                    resolve([]);
                }
            }
        }
    })
</script>
</html>